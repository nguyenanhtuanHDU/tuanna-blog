<app-header (passPostID)="reloadPostByNotice($event)"></app-header>
<router-outlet></router-outlet>
<div class="post-wrapper">
  <div class="row">
    <div class="post col-12 col-lg-8">
      <div class="posts-inner p-3 border-radius-12">
        <div class="posts-post-head d-flex justify-content-between">
          <div class="d-flex">
            <div class="posts-post-head-avatar me-3 border-radius-rounded">
              <img *ngIf="post && post.userAvatar" [src]="imagePath + 'avatars/' + post.userAvatar" alt="">
            </div>
            <div class="posts-post-head-info d-flex flex-column my-auto">
              <strong *ngIf="post && post.userUsername">{{post.userUsername}}</strong>
              <span *ngIf="post && post.createdAt">{{post.createdAt | TimeAgo}}</span>
              <!-- <div>{{post.createdAt | date}}</div> -->
            </div>
          </div>
          <div class="posts-post-head-tags">
            <!-- <strong class="text-white">#{{post.tag}}</strong> -->
            <app-tag-view *ngIf="post && post.tag" [type]="post.tag"></app-tag-view>
          </div>
        </div>
        <div class="posts-post-body my-4">
          <strong *ngIf="post && post.title" class="posts-post-body-title mb-2">{{post.title}}</strong>
          <div class="posts-post-body-images my-4" slickContainer #slickController="slick" [slickConfig]="config">
            <ng-container *ngIf="post && post.images">
              <img class="posts-post-body-images-image" slickItem *ngFor="let image of post.images"
                [src]="imagePath + 'posts/'+ image" alt="">
            </ng-container>
          </div>
          <p *ngIf="post && post.content" class="posts-post-body-content">{{post.content}}</p>
          <!-- <button (click)="slickController.pause()">Pause</button> -->
        </div>
        <div class="posts-post-footer d-flex justify-content-between">
          <div class="posts-post-footer-likes d-flex">
            <label *ngIf="userSession && userSession.likes.length > 0 && post" [for]=" post._id"
              [ngClass]="{'posts-post-footer-icon': userSession.likes.length > 0 && !userSession.likes.includes(post._id), 'second': true, 'third': false}"
              class="me-2" [class.active]="userSession.likes.includes(post._id)">
              <i class="bi bi-suit-heart-fill text-white"></i>
            </label>
            <input *ngIf="userSession && userSession.likes.length > 0 && post"
              style="overflow: hidden; width: 0; height: 0;" type="checkbox" [id]="post._id" value="like"
              [checked]="userSession.likes.includes(post._id)" (change)="updateStatusLike($event, post._id)">
            <a *ngIf="post && post.likers" class="posts-post-footer-count text-decoration-none" [title]="post.likers"
              (click)="openModalViewLikers(modalViewLikers)">
              {{countLikes(post.likers)}}
            </a>
            <div bsModal #modalViewLikers="bs-modal" class="modal fade" tabindex="-1" role="dialog"
              aria-labelledby="dialog-sizes-name1">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h4 id="dialog-sizes-name1" class="modal-title pull-left">List users likes</h4>
                    <button type="button" class="btn-close close pull-right" (click)="modalViewLikers.hide()"
                      aria-label="Close">
                      <span aria-hidden="true" class="visually-hidden">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <ng-container *ngIf="post && post.likers">
                      <div *ngFor="let liker of post.likers"
                        class="posts-post-footer-likers flex-center-y gap-3 my-3 p-2">
                        <!-- <div>{{liker.userLikeID}}</div> -->
                        <div class="posts-post-footer-likers__image">
                          <img [src]="imagePath + 'avatars/' + liker.avatar" />
                        </div>
                        <div class="posts-post-footer-likers__content">
                          <strong class="posts-post-footer-likers__username">{{liker.username}}</strong>
                          <div class="posts-post-footer-likers__time">{{liker.createdAt | TimeAgo}}</div>
                          <!-- <pre>{{liker | json}}</pre> -->
                        </div>
                      </div>
                    </ng-container>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="posts-post-footer-views d-flex">
            <span *ngIf="post && post.views" class="me-2 posts-post-footer-count">{{post.views}}</span>
            <div class="posts-post-footer-icon"><i class="bi bi-eye-fill text-white"></i></div>
          </div>
          <!-- <div>
            <pre>{{post.comments | json}}</pre>
          </div> -->

        </div>
      </div>
      <ng-scrollbar style="height: 180px" #commentScrollbar appearance="standard">
        <ng-container *ngIf="post && post.comments">
          <div class="posts-inner-comment d-flex gap-2 my-3 p-2"
            *ngFor="let comment of post.comments; trackBy: trackByFn">
            <!-- <pre>{{comment | json}}</pre> -->
            <div class="posts-inner-comment-image" type="button" [routerLink]="['/profile', comment.author._id]">
              <img [src]="imagePath + 'avatars/' + comment.author.avatar" width="50">
            </div>
            <div class="posts-inner-comment-content">
              <div class="d-flex justify-content-between">
                <div class="posts-inner-comment-content__username fw-6 text-primary" type="button"
                  [routerLink]="['/profile', comment.author._id]">{{comment.author.username}}</div>
                <div class="posts-inner-comment-content__time">
                  <span>{{comment.updatedAt | TimeAgo}}</span>
                </div>
                <div class="posts-inner-comment-content__time" *ngIf="comment.updatedAt > comment.createdAt">Edited
                </div>
              </div>
              <p class="mb-0 p-2">{{comment.content}}</p>
              <ng-container *ngIf="userSession && userSession._id">
                <button *ngIf="comment.author._id === userSession._id" class="btn text-primary flex-center"
                  style="right: 35px;" (click)="openFormEditComment(editCommentModal, comment._id, comment.content)">
                  <i class="bi bi-pencil-square"></i>
                </button>
                <button *ngIf="comment.author._id === userSession._id" class="btn text-danger flex-center"
                  style="right: 5px;" (click)="deleteCommentByID(comment._id)">
                  <i class="bi bi-trash"></i>
                </button>
              </ng-container>
              <ng-template #editCommentModal>
                <div class="modal-header">
                  <h4 class="modal-title pull-left">Edit your comment</h4>
                  <button type="button" class="btn-close close pull-right" aria-label="Close"
                    (click)="modalCreateCommentRef?.hide()">
                    <span aria-hidden="true" class="visually-hidden">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <form class="d-flex gap-2" (ngSubmit)="editComment(comment._id)" [formGroup]="formEditComment">
                    <input class="form-control" type="text" #editCommentInput formControlName="content" />
                    {{ editCommentInput.focus() }}
                    <button class="btn btn-primary d-flex gap-1" type="submit">
                      <span>Update</span>
                      <i class="bi bi-check-circle-fill"></i>
                    </button>
                  </form>
                </div>
              </ng-template>
            </div>
          </div>
        </ng-container>
      </ng-scrollbar>

      <div class="d-flex my-3 gap-2 align-items-center">
        <form class="d-block w-100 posts-inner-form" action="" [formGroup]="formCreateComment"
          (ngSubmit)="createComment(post._id)">
          <input #inputComment formControlName="content" placeholder="Type your comment" class="form-control"
            type="text" />
          <button type="submit" class="btn">
            <i class="bi bi-send"></i>
          </button>
        </form>
        <div class="btn-group posts-inner-btns" dropdown [dropup]="true" placement="end">
          <ng-container *ngIf="post && userSession && post.userID === userSession._id">
            <button id="button-dropup" dropdownToggle type="button"
              class="flex-center border-radius-rounded btn btn-primary dropdown-toggle" aria-controls="dropdown-dropup">
              <i class="bi bi-three-dots"></i>
            </button>
          </ng-container>
          <ul id="dropdown-dropup" *dropdownMenu class="p-2 dropdown-menu" role="menu" aria-labelledby="button-dropup">
            <li role="menuitem" class="p-2" *ngIf="userSession._id === post.userID"
              (click)="openModalEditPost(post._id)">
              <i class="flex-center me-1 bi bi-pencil-square"></i> Edit
            </li>
            <li role="menuitem" class="p-2" *ngIf="userSession._id === post.userID" (click)="deletePost(post._id)">
              <i class="flex-center me-1 bi bi-trash"></i>
              Delete
            </li>
          </ul>
        </div>
      </div>
    </div>
    <!-- <div>
      <pre>{{post.comments | json}}</pre>
    </div> -->
    <div class="col-12 col-lg-4 d-flex flex-column gap-3">
      <app-post-top (passPostID)="reloadPostByNotice($event)" (changeViews)="onAngleChanged($event)"
        [postsTop]="postsViewers" type="views" icon="bi bi-eye-fill">top viewers</app-post-top>
      <app-post-top (passPostID)="reloadPostByNotice($event)" [postsTop]="postsLikers" type="likers"
        icon="bi bi-suit-heart-fill">top likes</app-post-top>
    </div>

  </div>
</div>

<div bsModal #createPostModal="bs-modal" class="modal fade" tabindex="-1" role="dialog"
  aria-labelledby="dialog-sizes-name1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h4 id="dialog-sizes-name1" class="modal-title pull-left">Edit post </h4>
        <button type="button" class="btn-close close pull-right" (click)="createPostModal.hide()" aria-label="Close">
          <span aria-hidden="true" class="visually-hidden">&times;</span>
        </button>
      </div>
      <div class="modal-body post">
        <tabset type="pills" class="post-tabs">
          <tab heading="Content" class="post-tabs-tab p-3 my-3">
            <form class="post-tabs-tab-content" [formGroup]="formEditPost">
              <div class="form-group">
                <label for="title">Title</label>
                <input class="form-control" id="title" formControlName="title">
              </div>
              <div class="form-group">
                <label for="content">Content</label>
                <textarea class="form-control" id="content" formControlName="content"></textarea>
              </div>
              <div class="form-group">
                <label for="tag">Tags</label>
                <select id="tag" class="form-select" aria-label="Default select example" formControlName="tag">
                  <option value="Asia">Asia</option>
                  <option value="Europe">Europe</option>
                  <option value="Africa">Africa</option>
                  <option value="America">America</option>
                  <option value="Oceania">Oceania</option>
                  <option value="Antarctica">Antarctica</option>
                </select>
              </div>
            </form>
          </tab>

          <tab heading="Images" class="post-tabs-tab p-3 my-3">
            <ng-scrollbar style="max-height: 510px; height: 438px;" appearance="standard">
              <form class="post-tabs-tab-imgs" [formGroup]="formEditPost">
                <!-- <div class="form-group">
                  <label for="image"></label>
                  <input type="file" accept="image/*" formControlName="images" (change)="selectImagesPost($event)"
                    multiple class="form-control-file" id="image">
                </div> -->
                <div class="row">
                  <strong class="my-2">Current Images</strong>
                  <div class="col-6 col-md-4 col-lg-3 post-tabs-tab-imgs-img mb-4"
                    *ngFor="let img of imagesSelected; index as i">
                    <img class="border-radius-8" [src]="imagePath + '/posts/' + img" alt="">
                    <button class="flex-center"><i class="bi bi-x" (click)="deleteImagePost(i, 'old')"></i></button>
                  </div>
                </div>
                <div class="row">
                  <strong class="my-2" *ngIf="newImagesSelected.length > 0">New Images</strong>
                  <div class="col-6 col-md-4 col-lg-3 post-tabs-tab-imgs-img mb-4"
                    *ngFor="let img of newImagesSelected; index as i">
                    <img class="border-radius-8" [src]="img" alt="">
                    <button class="flex-center"><i class="bi bi-x" (click)="deleteImagePost(i, 'new')"></i></button>
                  </div>
                </div>
                <div class="form-group">
                  <label for="image2" class="btn btn-primary">
                    Add Image
                    <i class="bi bi-plus-circle-fill"></i>
                  </label>
                  <input type="file" accept="image/*" formControlName="images" (change)="selectImagesPost($event)"
                    multiple class="form-control-file d-none" id="image2">
                </div>
              </form>
            </ng-scrollbar>
          </tab>
        </tabset>
        <button class="btn btn-primary" type="submit" (click)="editPost()">
          <span>Edit</span>
          <i class="bi bi-pencil-square ms-1"></i></button>
      </div>
    </div>
  </div>
</div>
